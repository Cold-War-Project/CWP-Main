# ----------------------------------------------
# General info about government building targets
# ----------------------------------------------

# THIS IS NOT ENTIRELY CORRECT ANYMORE I'll remove it when I entirely reworked budgeting

# Government buildings don't produce goods in most cases, so you can't judge them by productivity or whatever, you need
# to establish some special measure of how important are they and how much of them a country needs. To solve this two
# values are introduced for each government building, share and target.

# Share is % of budget income of a country that it can spend on this building weekly to pay for wages and input good.
# Usually it's pretty rigid, roughly set to what works the best, but with some dynamic factors added in more cases.
# For example, government administration share is higher when tax capacity is low country-wide. Construction sector
# is special in a sense that it has no base or fixed share, instead it just takes all what's left after other shares.
# Please note that for AI shares are always calculated for normal tax and wage level, otherwise it would be unstable.
# Again consruction sector are special here, they always assume high tax level at the beginning for faster development
# of economy, but when a country won't have much free workforce left, sector will demand less and less money, down to
# normal tax level and even a bit below it.

# Target is arbitrary value on how much stuff a country wants to have, be it spare bureaucracy, innovation, battalions,
# convoys, everything. Except construction sectors, of course. They have no target. Anyways, targets are calculated by
# some random ass formulas, most of the time in some form of population multiplied by some form of GDP per capita, with
# a bunch of other factors thrown in. If country is below target, but expenses already exceed share, it won't construct
# more in most cases, so share acts as a limiter. If country reached target but not share, it may build some more of
# this building cause why not if they are rich enough for that.

# --------------------------------------------------------------
# Various common factors that affect government building targets
# --------------------------------------------------------------

# If a country is forced to spend most of its money on government administrations, we need to lower other shares
# Called : building, port, university share
# Range : [0.25, 1]
aroai_target_multiplier_with_high_government_spending = {
    value = 1
    subtract = {
        value = {
            value = aroai_building_government_administration_spending_value
            divide = aroai_country_active_income
        }
        divide = {
            value = aroai_building_government_administration_spending_share
            multiply = 1.20
        }
        subtract = 1
        min = 0
        max = 0.75
    }
}


# If construction is largely sponsored by investment pool, we want to raise non-construction shares
# Range : [1, 2.2]
aroai_target_multiplier_with_investment_pool = {
    value = 1.00
    add = {
        value = 1.20
        multiply = {
            value = aroai_investment_pool_expected
            divide = aroai_country_active_income
            divide = 0.30
            min = 0
            max = 1
        }
    }
}


# ----------------------------------------------
# General info about budget management
# ----------------------------------------------

# Government buildings do not typically produce goods, so it is not possible to judge their productivity. Instead, it is
# necessary to establish a special measure of their importance and the quantity needed by a country.

# When it comes to ports, the goal is to have enough to facilitate the growth of trade routes, as it is a self-sustaining
# investment. Having more ports than necessary would be a waste of money. However, we never downsize them as they're
# usually insignificant spending.

# University and bureaucracy have a special system, I won't describe them as they'll probably be reworked at some point.

# This leaves us with the military and construction sectors. A country can be in one of two states: industrialized or
# industrializing. In order to employ its citizens as quickly as possible, a country is considered industrialized if it
# can provide employment for almost all of its unemployed citizens by the end of the year. We calculate the number of
# construction points required for this based on aroai_max_wanted_constructions_points_from_pop. If a country cannot
# afford that many construction points, it is still in the process of industrializing.

# If the country is still in the industrializing phase, we calculate the amount of money that can be allocated to the
# military and construction sectors using aroai_revenue_left_for_construction_military. In an ideal scenario, 25% of
# this amount would be allocated to the military, while 75% would go to the construction sector. However, there are two
# factors to consider: 1) the budget's instability and 2) the rigid nature of military spending, as aroai does not have
# control over the production methods. We aim to minimize downsizing as much as possible since we cannot remove individual
# levels of buildings; we can only delete entire buildings. Furthermore, we can easily regulate the amount of money
# allocated to construction by reducing the number of construction points available.
# (Please note that buildings cannot be removed from the construction queue.)

# A separate system will try to align the actual military spending with the target of 25% of
# aroai_revenue_left_for_construction_military. This system will undergo revisions at some point. The remaining funds,
# aroai_revenue_left_for_construction, will be available for the construction sector.

# If the country is already industrialized, we know the exact number of construction points needed:
# aroai_max_wanted_constructions_points_from_pop. We allocate this amount of money to the construction sector and
# allocate the remaining funds to the military sector.


# Effective construction share of income
# Min : 1 - sum of every other theoretical share
aroai_revenue_left_for_construction_military = {
    value = weekly_net_fixed_income

    add = aroai_building_barracks_spending_value
    add = aroai_building_naval_base_spending_value

    multiply = aroai_revenue_factor_construction_military
}

aroai_revenue_left_for_construction_military_old = {
    value = income

    subtract = aroai_investment_pool_net_spending

    multiply = aroai_subject_type_diplo_pact_income_mult

    subtract = {
        value = aroai_building_government_administration_spending_value
        add = aroai_building_university_spending_value
        add = aroai_building_port_spending_value
        add = aroai_building_research_institute_spending
        add = var:aroai_total_subsidies
    }

    multiply = aroai_revenue_factor_construction_military
}



aroai_revenue_left_for_construction = {
    value = aroai_revenue_left_for_construction_military

    subtract = {
        value = aroai_building_barracks_spending_value
        add = aroai_building_naval_base_spending_value
    }
}


# ----------------------------------------------
# General info about aroai_revenue_factor_construction_military
# ----------------------------------------------


# gold reserve in weeks of income
aroai_gold_reserve_scaled = {
    value = gold_reserves
    divide = income
    min = 0

}

# [0.6, INF], = 1 when you have 20 x income in gold reserve
aroai_gold_reserve_scaled_factor = {
    value = aroai_gold_reserve_scaled
    multiply = 0.4 # without this, factor would be 1.6 at x week

    divide = 10
    add = 0.6
}

# [0, 0.6], = 0 at half of allowed credit
aroai_debt_scaled_factor = {
    value = 0.5
    subtract = scaled_debt
    min = 0
    multiply = 2    # to get a [0, 1] range
    multiply = 0.6  # to get a [0, 0.6] range
}

# We take the max value between the two
# The purpose of this  functions is to keep budget balanced.
# Sometimes, the ai will spend more than they should on military this leads to less gold reserve, so smaller factor so smaller expense.
# Sometimes, the ai will spend less than allocated on military. This leads to bigger gold reserve, money that should be spend. The factor will then artificially raise the budget for construction and military.
# The balance is X weeks of revenue for the gold reserve.
aroai_revenue_factor_construction_military = {
    value = {
        if = {
            limit = {
                aroai_debt_scaled_factor < 0.6
            }
            value = aroai_debt_scaled_factor
        }
        else = {
             value = aroai_gold_reserve_scaled_factor
        }
    }
}


# ----------------------------------------------
# General info about aroai_revenue_factor_construction_military
# ----------------------------------------------


#
# tag           : tag_aroai_max_wanted_constructions_depense_from_pop
# Called by     : aroai_max_wanted_constructions_revenue_share_from_pop
# Let's imagine we don't have any investment pool, how much money would we need to employ everyone ?
#
aroai_construction_depense_maximum_from_pop = {
    value = aroai_max_wanted_constructions_points_from_pop
    multiply = aroai_building_construction_sector_expenses_per_point
}

aroai_construction_depense_maximum_from_budget = {
    value = aroai_revenue_left_for_construction_military
    multiply = 0.75
}


aroai_investment_pool_net_spending = {
    value = investment_pool_gross_income
    subtract = investment_pool_net_income
}

aroai_investment_pool_wanted_spending = {
    value = investment_pool_gross_income
    add = {
        value = investment_pool
        divide = 20
    }
}




aroai_budget_for_construction_sector_expected = {

    value = aroai_construction_depense_maximum_from_pop

    subtract = {
        value = aroai_investment_pool_net_spending
        multiply = 0.8
    }

    max = aroai_construction_depense_maximum_from_budget
}

aroai_budget_for_military_sector_expected = {
    value = aroai_revenue_left_for_construction_military
    subtract = aroai_budget_for_construction_sector_expected
}

aroai_budget_for_construction_sector_actual = {

    value = aroai_construction_depense_maximum_from_pop

    subtract = {
        value = aroai_investment_pool_net_spending
        multiply = 0.8
    }

    max = aroai_revenue_left_for_construction
}


aroai_construction_points_wanted_total = {
    # First we take the smallest value between the two
    value = aroai_construction_depense_maximum_from_pop
    max = aroai_construction_depense_maximum_from_budget

    # add the max depense from investment pool
    add = aroai_investment_pool_wanted_spending

    divide = aroai_building_construction_sector_expenses_per_point

    min = 15
}



aroai_construction_points_wanted_for_gov = {
    value = aroai_budget_for_construction_sector_actual
    divide = aroai_building_construction_sector_expenses_per_point

    min = {
        value = aroai_construction_points_current
        multiply = 0.1
    }
}


aroai_military_spending_share = {
    value = aroai_budget_for_military_sector_expected
    divide = income
}


#
# tag           : tag_aroai_building_construction_sector_spending_value
# Called by     : aroai_calculate_budget_surplus aroai_building_construction_sector_spending_expected
# Effective Construction Spending
# Does NOT assume that we pay for every construction point
#
aroai_building_construction_sector_spending_value = {
    if = {
        limit = {
            has_variable = aroai_previous_building_construction_sector_expenses
        }
        value = var:aroai_previous_building_construction_sector_expenses
    }
    else = {
        value = 0
    }
    min = 0
    max = 1000000000 #billion
}


aroai_building_barracks_vs_naval_base_share = {
    if = {
        limit = {
            has_variable = aroai_building_barracks_total
            var:aroai_building_barracks_total > 0
            has_variable = aroai_building_naval_base_total
            var:aroai_building_naval_base_total > 0
            has_variable = aroai_building_barracks_spending
            var:aroai_building_barracks_spending > 0
            has_variable = aroai_building_naval_base_spending
            var:aroai_building_naval_base_spending > 0
        }
        value = {
            value = aroai_battalion_target
            divide = var:aroai_building_barracks_total
            multiply = var:aroai_building_barracks_spending
        }
        divide = {
            value = {
                value = aroai_battalion_target
                divide = var:aroai_building_barracks_total
                multiply = var:aroai_building_barracks_spending
            }
            add = {
                value = aroai_flotilla_target
                divide = var:aroai_building_naval_base_total
                multiply = var:aroai_building_naval_base_spending
            }
            min = 1
        }
    }
    else = {
        value = {
            value = aroai_battalion_target
            divide = {
                value = aroai_battalion_target
                add = aroai_flotilla_target
                min = 1
            }
        }
    }
    max = 0.80
}


aroai_subject_type_diplo_pact_income_mult = {
    if = {
        limit = { is_subject_type = subject_type_puppet}
        value = 0.7
    }
    else_if = {
        limit = { is_subject_type =  subject_type_dominion }
        value = 0.75
    }
    else_if = {
        limit = { is_subject_type =  subject_type_vassal }
        value = 0.75
    }
    else_if = {
        limit = { is_subject_type =  subject_type_tributary }
        value = 0.8
    }
    else = {
        value = 1
    }
}